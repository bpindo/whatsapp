<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Obrolan Kita</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#075E54">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- LIB -->
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/webtorrent@0.115.0/webtorrent.min.js"></script>

<style>
/* === (CSS ASLI TIDAK DIUBAH) === */
</style>
</head>

<body>

<div class="app">
  <div class="header">CEO yang hilang</div>

  <div id="chat"></div>

  <div class="input-bar">
    <input type="file" id="fileInput" hidden>
    <input id="msg" placeholder="Tuliskan keluh kesahmu...">
    <button id="sendBtn">âž¤</button>
  </div>
</div>

<script>
/* ===== ID ===== */
const names=["KucingHijau","MawarPutih","GajahBesar","SiLincah"];
const myId=names[Math.floor(Math.random()*names.length)]+Math.floor(Math.random()*1000);

/* ===== ELEMENT ===== */
const chat=document.getElementById("chat");
const msgInput=document.getElementById("msg");
const sendBtn=document.getElementById("sendBtn");
const fileInput=document.getElementById("fileInput");

/* ===== HELPERS ===== */
function addMsg(text,type,from=""){
  const row=document.createElement("div");
  row.className="row "+type;
  const bubble=document.createElement("div");
  bubble.className="bubble";
  bubble.textContent=text;
  row.appendChild(bubble);
  chat.appendChild(row);
  chat.scrollTop=chat.scrollHeight;
}

/* ===== SIGNALING ===== */
const SIGNALING_HOST="p2p-chat-production-3693.up.railway.app";
const ws=new WebSocket(
  (location.protocol==="https:"?"wss://":"ws://")+SIGNALING_HOST
);
const peers={};

ws.onopen=()=>{
  ws.send(JSON.stringify({type:"register",id:myId}));
};

ws.onmessage=e=>{
  const d=JSON.parse(e.data);
  if(d.type==="peers"){
    d.peers.forEach(pid=>{
      if(pid!==myId&&!peers[pid])createPeer(pid);
    });
  }
  if(d.signal){
    if(!peers[d.from])createPeer(d.from);
    peers[d.from].signal(d.signal);
  }
};

/* ===== PEER ===== */
function createPeer(pid){
  const peer=new SimplePeer({
    initiator:myId<pid,
    trickle:false
  });
  peers[pid]=peer;

  peer.on("signal",s=>{
    ws.send(JSON.stringify({from:myId,to:pid,signal:s}));
  });

  peer.on("data",d=>{
    const msg=d.toString();

    // ===== AUTO DOWNLOAD =====
    if(msg.startsWith("[MAGNET]")){
      const magnet=msg.slice(8);
      torrentClient.add(magnet,torrent=>{
        torrent.on("done",()=>{
          torrent.files.forEach(f=>{
            f.getBlobURL((_,url)=>{
              const a=document.createElement("a");
              a.href=url;
              a.download=f.name;
              a.textContent="â¬‡ï¸ Download "+f.name;
              chat.appendChild(a);
            });
          });
        });
      });
    }else{
      addMsg(msg,"peer",pid);
    }
  });
}

/* ===== SEND CHAT ===== */
sendBtn.onclick=()=>{
  const text=msgInput.value.trim();
  if(!text)return;
  Object.values(peers).forEach(p=>p.connected&&p.send(text));
  addMsg(text,"me");
  msgInput.value="";
};

/* ===== WEBTORRENT ===== */
const torrentClient=new WebTorrent();

/* ===== FILE UPLOAD â†’ HASH ONLY ===== */
document.addEventListener("keydown",e=>{
  if(e.ctrlKey&&e.key==="u"){
    fileInput.click();
  }
});

fileInput.onchange=()=>{
  const files=[...fileInput.files];
  if(!files.length)return;

  torrentClient.seed(files,torrent=>{
    const hash=torrent.infoHash.slice(0,12);

    // kirim magnet DIAM-DIAM
    Object.values(peers).forEach(p=>{
      if(p.connected)p.send("[MAGNET]"+torrent.magnetURI);
    });

    // tampilkan HASH SAJA
    addMsg(
`ðŸ“¦ File dibagikan
ðŸ”— Hash: ${hash}â€¦`,
      "me"
    );
  });
};
</script>

</body>
</html>