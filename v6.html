<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Obrolan Kita</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#075E54">

<style>
/* === CSS ASLI KAMU (TIDAK DIUBAH) === */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:#ece5dd;font-family:system-ui}
.app{display:flex;flex-direction:column;height:100vh;max-width:480px;margin:auto}
.header{background:#075e54;color:#fff;padding:12px;text-align:center}
#chat{flex:1;overflow-y:auto;padding:10px}
.row{display:flex;margin-bottom:6px}
.row.me{justify-content:flex-end}
.row.peer{justify-content:flex-start}
.bubble{max-width:75%;padding:8px 12px;border-radius:8px;background:#fff}
.me .bubble{background:#dcf8c6}
.input-bar{display:flex;padding:8px;background:#f0f0f0}
#msg{flex:1;border:none;border-radius:20px;padding:10px}
#sendBtn{margin-left:6px;border:none;border-radius:50%;width:40px;height:40px}
.system{text-align:center;font-size:12px;color:#666;margin:8px}
</style>
</head>

<body>
<div class="app">
  <div class="header">CEO yang hilang</div>
  <div id="chat"></div>

  <div class="input-bar">
    <input type="file" id="fileInput" hidden>
    <button onclick="fileInput.click()">ðŸ“Ž</button>
    <input id="msg" placeholder="Tuliskan pesan..." disabled>
    <button id="sendBtn" disabled>âž¤</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

<script>
/* ===== IDENTITAS ===== */
const myId = "User" + Math.floor(Math.random()*1000);
const chat = document.getElementById("chat");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");
const fileInput = document.getElementById("fileInput");

/* ===== CHAT UI ===== */
function addMsg(text,type){
  const r=document.createElement("div");
  r.className="row "+type;
  const b=document.createElement("div");
  b.className="bubble";
  b.textContent=text;
  r.appendChild(b);
  chat.appendChild(r);
  chat.scrollTop=chat.scrollHeight;
}
function systemMsg(t){
  const d=document.createElement("div");
  d.className="system";
  d.textContent=t;
  chat.appendChild(d);
}

/* ===== SIGNALING ===== */
const ws=new WebSocket("wss://p2p-chat-production-3693.up.railway.app");
const peers={};

ws.onopen=()=>ws.send(JSON.stringify({type:"register",id:myId}));

ws.onmessage=e=>{
  const d=JSON.parse(e.data);
  if(d.type==="peers"){
    d.peers.forEach(pid=>{
      if(pid!==myId&&!peers[pid])createPeer(pid);
    });
  }
  if(d.signal){
    if(!peers[d.from])createPeer(d.from);
    peers[d.from].signal(d.signal);
  }
};

/* ===== PEER ===== */
function createPeer(pid){
  const p=new SimplePeer({initiator:myId<pid,trickle:false});
  peers[pid]=p;

  p.on("signal",s=>{
    ws.send(JSON.stringify({from:myId,to:pid,signal:s}));
  });

  p.on("connect",()=>{
    systemMsg(pid+" bergabung");
    msgInput.disabled=false;
    sendBtn.disabled=false;
  });

  p.on("data",data=>{
    handleIncoming(data.toString(),pid);
  });
}

/* ===== WEBTORRENT (AMAN) ===== */
let torrentClient=null;
try{
  torrentClient=new WebTorrent();
}catch(e){
  console.error("WebTorrent gagal",e);
}

/* ===== FILE â†’ HASH ONLY ===== */
fileInput.onchange=()=>{
  if(!torrentClient)return;
  const file=fileInput.files[0];
  if(!file)return;

  torrentClient.seed(file,t=>{
    const magnet=t.magnetURI;
    addMsg("ðŸ“¦ File dibagikan\n"+t.infoHash,"me");

    broadcast(JSON.stringify({
      type:"torrent",
      magnet
    }));
  });
};

/* ===== DATA HANDLER ===== */
function handleIncoming(msg,from){
  try{
    const data=JSON.parse(msg);
    if(data.type==="torrent"){
      addMsg("â¬‡ï¸ File diterima\n"+data.magnet,"peer");
      torrentClient?.add(data.magnet);
      return;
    }
  }catch{}
  addMsg(msg,"peer");
}

/* ===== SEND TEXT ===== */
function broadcast(text){
  Object.values(peers).forEach(p=>{
    if(p.connected)p.send(text);
  });
}

sendBtn.onclick=()=>{
  const t=msgInput.value.trim();
  if(!t)return;
  broadcast(t);
  addMsg(t,"me");
  msgInput.value="";
};
</script>
</body>
</html>